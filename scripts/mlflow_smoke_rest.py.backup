import os
import time
from datetime import datetime, timezone
import requests


def _base_uri(uri: str) -> str:
    return uri.rstrip("/")


def _api(uri: str, path: str) -> str:
    return f"{_base_uri(uri)}{path}"


def _now_ms() -> int:
    return int(time.time() * 1000)


def get_or_create_experiment(uri: str, auth: tuple[str, str], name: str) -> str:
    # First, try to get existing experiment
    r = requests.post(
        _api(uri, "/api/2.0/mlflow/experiments/get-by-name"),
        json={"experiment_name": name},
        auth=auth,
        timeout=20,
    )
    if r.status_code == 200:
        return r.json()["experiment"]["experiment_id"]
    
    # If not found, try to create it
    r2 = requests.post(
        _api(uri, "/api/2.0/mlflow/experiments/create"),
        json={"name": name},
        auth=auth,
        timeout=20,
    )
    
    # Handle the case where experiment already exists
    if r2.status_code == 400:
        resp_json = r2.json()
        if resp_json.get("error_code") == "RESOURCE_ALREADY_EXISTS":
            # Try get-by-name again
            r3 = requests.post(
                _api(uri, "/api/2.0/mlflow/experiments/get-by-name"),
                json={"experiment_name": name},
                auth=auth,
                timeout=20,
            )
            r3.raise_for_status()
            return r3.json()["experiment"]["experiment_id"]
    
    r2.raise_for_status()
    return r2.json()["experiment_id"]


def main() -> None:
    tracking_uri = os.environ["MLFLOW_TRACKING_URI"]
    user = os.environ["MLFLOW_TRACKING_USERNAME"]
    token = os.environ["MLFLOW_TRACKING_PASSWORD"]
    auth = (user, token)
    
    exp_name = os.getenv("MLFLOW_EXPERIMENT_NAME", "rakuten-smoke")
    git_sha = os.getenv("GIT_SHA", "unknown")
    git_branch = os.getenv("GIT_BRANCH", "unknown")
    service = os.getenv("SERVICE_NAME", "mlflow_smoke_dagshub")
    run_type = os.getenv("RUN_TYPE", "smoke")
    ts_utc = datetime.now(timezone.utc).isoformat(timespec="seconds")
    
    start_ms = _now_ms()
    exp_id = get_or_create_experiment(tracking_uri, auth, exp_name)
    
    run_name = f"smoke-{ts_utc}"
    tags = [
        {"key": "mlflow.runName", "value": run_name},
        {"key": "service", "value": service},
        {"key": "run_type", "value": run_type},
        {"key": "timestamp_utc", "value": ts_utc},
        {"key": "git_sha", "value": git_sha},
        {"key": "git_branch", "value": git_branch},
    ]
    
    r = requests.post(
        _api(tracking_uri, "/api/2.0/mlflow/runs/create"),
        json={"experiment_id": exp_id, "start_time": start_ms, "tags": tags},
        auth=auth,
        timeout=20,
    )
    r.raise_for_status()
    run_id = r.json()["run"]["info"]["run_id"]
    
    requests.post(
        _api(tracking_uri, "/api/2.0/mlflow/runs/log-metric"),
        json={"run_id": run_id, "key": "smoke_ok", "value": 1.0, "timestamp": _now_ms(), "step": 0},
        auth=auth,
        timeout=20,
    ).raise_for_status()
    
    requests.post(
        _api(tracking_uri, "/api/2.0/mlflow/runs/log-parameter"),
        json={"run_id": run_id, "key": "tracking_uri", "value": _base_uri(tracking_uri)},
        auth=auth,
        timeout=20,
    ).raise_for_status()
    
    requests.post(
        _api(tracking_uri, "/api/2.0/mlflow/runs/update"),
        json={"run_id": run_id, "status": "FINISHED", "end_time": _now_ms()},
        auth=auth,
        timeout=20,
    ).raise_for_status()
    
    print(f"OK: logged DAGsHub smoke run: {run_name}")
    print(f"Run: {_base_uri(tracking_uri)}/#/experiments/{exp_id}/runs/{run_id}")


if __name__ == "__main__":
    main()
